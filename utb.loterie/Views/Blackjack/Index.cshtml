@{
    ViewData["Title"] = "Royal Blackjack";
}

<style>
    .blackjack-table {
        background-color: #0f3b25;
        border: 12px solid #5c3a13; 
        border-radius: 30px;
        padding: 40px 20px;
        box-shadow: inset 0 0 100px #000, 0 0 30px rgba(0,0,0,0.5);
        min-height: 600px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        position: relative;
    }

    .table-logo {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 3rem;
        font-weight: bold;
        color: rgba(0,0,0,0.2);
        text-transform: uppercase;
        pointer-events: none;
        user-select: none;
        white-space: nowrap;
    }

    .hand-area {
        margin-bottom: 20px;
        text-align: center;
        z-index: 2;
    }

    .hand-title {
        color: #d4af37;
        font-weight: bold;
        text-transform: uppercase;
        margin-bottom: 15px;
        text-shadow: 1px 1px 2px black;
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    .score-display {
        display: inline-block;
        background: #222;
        color: #fff;
        padding: 2px 12px;
        border-radius: 12px;
        font-weight: bold;
        border: 1px solid #d4af37;
        min-width: 40px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    }

    .cards-container {
        display: flex;
        justify-content: center;
        gap: 15px; 
        min-height: 140px;
        perspective: 1000px;
    }

    .card {
        width: 100px;
        height: 145px;
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 3px 3px 10px rgba(0,0,0,0.6);
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        padding: 10px;
        font-weight: bold;
        font-size: 1.6rem;
        position: relative;
        transition: transform 0.3s, margin 0.3s;
        user-select: none;
    }

        .card.face-down {
            background: repeating-linear-gradient( 45deg, #8b0000, #8b0000 10px, #5c0000 10px, #5c0000 20px );
            border: 4px solid #fff;
        }

        .card.new-card {
            animation: dealCard 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
    @@keyframes dealCard {
        from

    {
        opacity: 0;
        transform: translateY(-100px) scale(0.5) rotate(10deg);
    }

    to {
        opacity: 1;
        transform: translateY(0) scale(1) rotate(0deg);
    }

    }

    .suit-hearts, .suit-diamonds {
        color: #d00000;
    }

    .suit-clubs, .suit-spades {
        color: #222;
    }

    .card-corner-top {
        align-self: flex-start;
        line-height: 1;
        font-size: 1.2rem;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .card-center-suit {
        font-size: 3rem;
        align-self: center;
        position: absolute;
        top: 52%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

    .card-corner-bottom {
        align-self: flex-end;
        transform: rotate(180deg);
        line-height: 1;
        font-size: 1.2rem;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .controls-area {
        background: rgba(0,0,0,0.7);
        padding: 25px;
        border-radius: 20px;
        border: 2px solid #d4af37;
        text-align: center;
        max-width: 600px;
        margin: 0 auto;
        backdrop-filter: blur(5px);
        z-index: 10;
    }

    #message-area {
        font-size: 1.1rem;
        font-weight: bold;
        min-height: 1.5em;
        margin-bottom: 20px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .win-pulse {
        animation: winPulseAnim 1s infinite alternate;
        color: #4ade80 !important;
        text-shadow: 0 0 10px #4ade80;
    }

    .lose-pulse {
        color: #ff4d4d !important;
        text-shadow: 0 0 10px #ff0000;
    }
    @@keyframes winPulseAnim {
        from

    {
        transform: scale(1);
    }

    to {
        transform: scale(1.1);
    }

    }

    .bet-input-group {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0;
        margin-bottom: 20px;
    }

        .bet-input-group .input-group-text {
            background-color: #222;
            color: #d4af37;
            border: 1px solid #444;
        }

    #stakeInput {
        background-color: #111;
        color: #fff;
        border: 1px solid #444;
        font-size: 1.5rem;
        max-width: 120px;
    }

    .action-btn {
        transition: all 0.2s;
        text-transform: uppercase;
        letter-spacing: 1px;
        min-width: 140px;
    }

        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
</style>

<div class="container mt-5 mb-5">
    <div class="text-center mb-4">
        <h1 class="display-4 fw-bold text-white">ROYAL <span class="text-warning">BLACKJACK</span></h1>
        <p class="text-muted">Dealer stojí na 17 • Blackjack vyplácí 3:2 • Štěstí přeje odvážným</p>
    </div>

    <div class="blackjack-table">
        <div class="table-logo">Blackjack Pro</div>

        <div class="hand-area dealer-area">
            <div class="hand-title">
                <i class="fas fa-user-tie"></i> Dealer
                <span id="dealer-score" class="score-display" style="visibility: hidden;">0</span>
            </div>
            <div id="dealerCards" class="cards-container">
            </div>
        </div>

        <div class="controls-area my-3">
            <div id="message-area" class="text-white">Vsaďte si a začněte hru.</div>

            <div id="bettingControls">
                <div class="bet-input-group">
                    <span class="input-group-text fw-bold">SÁZKA</span>
                    <input type="number" id="stakeInput" class="form-control fw-bold text-center" value="100" min="10" step="10">
                    <span class="input-group-text fw-bold">Kč</span>
                </div>

                <button id="dealBtn" class="btn btn-outline-warning btn-lg fw-bold px-5 rounded-pill action-btn d-inline-flex align-items-center gap-2">
                    <span>ROZDAT KARTY</span>
                    <i class="fas fa-play"></i>
                </button>
            </div>

            <div id="gameControls" style="display: none;">
                <div class="d-flex justify-content-center gap-3">
                    <button id="hitBtn" class="btn btn-outline-success btn-lg fw-bold px-4 rounded-pill action-btn">
                        <i class="fas fa-plus me-2"></i> HIT (Další)
                    </button>
                    <button id="standBtn" class="btn btn-outline-danger btn-lg fw-bold px-4 rounded-pill action-btn">
                        <i class="fas fa-hand-paper me-2"></i> STAND (Stát)
                    </button>
                </div>
            </div>
        </div>

        <div class="hand-area player-area">
            <div class="hand-title">
                <i class="fas fa-user"></i> Hráč
                <span id="player-score" class="score-display" style="visibility: hidden;">0</span>
            </div>
            <div id="playerCards" class="cards-container">
            </div>
        </div>
    </div>
</div>

<script>
    let currentGameId = null;

    const elements = {
        dealBtn: document.getElementById('dealBtn'),
        hitBtn: document.getElementById('hitBtn'),
        standBtn: document.getElementById('standBtn'),
        bettingControls: document.getElementById('bettingControls'),
        gameControls: document.getElementById('gameControls'),
        messageArea: document.getElementById('message-area'),
        stakeInput: document.getElementById('stakeInput'),
        dealerCards: document.getElementById('dealerCards'),
        playerCards: document.getElementById('playerCards'),
        dealerScore: document.getElementById('dealer-score'),
        playerScore: document.getElementById('player-score'),
        balance: document.getElementById('userBalance') 
    };

    elements.dealBtn.addEventListener('click', startGame);
    elements.hitBtn.addEventListener('click', hit);
    elements.standBtn.addEventListener('click', stand);


    async function startGame() {
        const stake = parseFloat(elements.stakeInput.value);
        if (isNaN(stake) || stake <= 0) { showMessage("Neplatná sázka.", "text-danger"); return; }

        setControlsDisabled(true);
        showMessage("Rozdávám karty...");

        try {
            const response = await fetch('/Blackjack/Start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ stake: stake })
            });
            await handleApiResponse(response);
        } catch (e) { handleError(e); }
    }

    async function hit() {
        if (!currentGameId) return;
        setControlsDisabled(true);
        try {
            const response = await fetch('/Blackjack/Hit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ gameId: currentGameId })
            });
            await handleApiResponse(response);
        } catch (e) { handleError(e); }
    }

    async function stand() {
        if (!currentGameId) return;
        setControlsDisabled(true);
        showMessage("Dealer hraje...");
        try {
            const response = await fetch('/Blackjack/Stand', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ gameId: currentGameId })
            });
            await handleApiResponse(response);
        } catch (e) { handleError(e); }
    }


    async function handleApiResponse(response) {
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || "Chyba serveru.");
        }
        const gameState = await response.json();
        updateUI(gameState);

        if (gameState.status === "PlayerTurn") {
            setControlsDisabled(false);
        } else {
             setControlsDisabled(false); 
        }
    }

    function handleError(e) {
        console.error(e);
        if (e.message && !e.message.includes("Hra již byla dokončena")) {
            showMessage(e.message, "text-danger fw-bold");
        }

        setControlsDisabled(false);
        resetToBettingState();
    }

    function resetToBettingState() {
        elements.bettingControls.style.display = 'block';
        elements.gameControls.style.display = 'none';
        currentGameId = null;
    }


    function updateUI(gameState) {
        currentGameId = gameState.gameId;

        let msgClass = "text-white";
        if (gameState.isWin) msgClass = "text-success fw-bold win-pulse";
        else if (gameState.status === "Finished" && gameState.winAmount === 0) msgClass = "text-danger fw-bold lose-pulse";
        else if (gameState.status === "Finished" && gameState.winAmount > 0) msgClass = "text-success fw-bold"; 

        showMessage(gameState.message, msgClass);

        elements.dealerScore.innerText = gameState.dealerScore;
        elements.dealerScore.style.visibility = 'visible';
        elements.playerScore.innerText = gameState.playerScore;
        elements.playerScore.style.visibility = 'visible';

        renderCards(elements.dealerCards, gameState.dealerCards);
        renderCards(elements.playerCards, gameState.playerCards);

        if (gameState.status === "PlayerTurn") {
            elements.bettingControls.style.display = 'none';
            elements.gameControls.style.display = 'block';
        } else {
            elements.bettingControls.style.display = 'block';
            elements.gameControls.style.display = 'none';
            currentGameId = null;
        }

        if (elements.balance) {
            elements.balance.innerText = new Intl.NumberFormat('cs-CZ').format(gameState.newBalance) + " Kč";
            if (gameState.winAmount > 0) {
                elements.balance.style.color = "#4ade80"; 
                setTimeout(() => elements.balance.style.color = "", 1500);
            }
        }
    }

    function renderCards(container, cardsData) {
        container.innerHTML = '';
        cardsData.forEach((cardData, index) => {
            const cardEl = document.createElement('div');
            cardEl.className = `card new-card`;
            cardEl.style.animationDelay = `${index * 100}ms`;

            if (!cardData.isFaceUp) {
                cardEl.classList.add('face-down');
            } else {
                const suitClass = `suit-${cardData.suit.toLowerCase()}`;
                cardEl.classList.add(suitClass);

                const rankSymbol = getRankSymbol(cardData.rank);
                const suitSymbol = getSuitSymbol(cardData.suit);

                cardEl.innerHTML = `
                    <div class="card-corner-top"><span>${rankSymbol}</span><span>${suitSymbol}</span></div>
                    <div class="card-center-suit">${suitSymbol}</div>
                    <div class="card-corner-bottom"><span>${rankSymbol}</span><span>${suitSymbol}</span></div>
                `;
            }
            container.appendChild(cardEl);
        });
    }

    function getRankSymbol(rankString) {
        const rankMap = {
            'Two': '2', 'Three': '3', 'Four': '4', 'Five': '5',
            'Six': '6', 'Seven': '7', 'Eight': '8', 'Nine': '9',
            'Ten': '10', 'Jack': 'J', 'Queen': 'Q', 'King': 'K', 'Ace': 'A'
        };
        return rankMap[rankString] || rankString;
    }

    function getSuitSymbol(suit) {
        return { 'Hearts': '♥️', 'Diamonds': '♦️', 'Clubs': '♣️', 'Spades': '♠️' }[suit];
    }

    function showMessage(msg, className = "text-white") {
        elements.messageArea.innerText = msg;
        elements.messageArea.className = `mb-3 ${className}`;
    }

    function setControlsDisabled(disabled) {
        elements.dealBtn.disabled = disabled;
        elements.hitBtn.disabled = disabled;
        elements.standBtn.disabled = disabled;
    }
</script>